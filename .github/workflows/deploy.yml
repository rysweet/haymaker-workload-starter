name: Deploy to Azure

# Manual trigger only -- prevents accidental deployments.
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options: [dev, staging, prod]
      location:
        description: "Azure region"
        required: true
        default: "eastus"
        type: string

# OIDC requires these permissions for the GitHub token.
permissions:
  id-token: write
  contents: read

env:
  RG_NAME: haymaker-starter-${{ inputs.environment }}-rg
  ACR_NAME: hmstarter${{ inputs.environment }}

jobs:
  # -------------------------------------------------------------------
  # Job 1: Build container image and push to ACR
  # -------------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.push.outputs.image }}
      acr_name: ${{ steps.create-acr.outputs.acr_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Create resource group
        run: |
          az group create \
            --name "$RG_NAME" \
            --location "${{ inputs.location }}" \
            --tags Environment=${{ inputs.environment }} Project=haymaker-starter

      - name: Create ACR (idempotent)
        id: create-acr
        run: |
          # ACR names must be globally unique -- append a hash
          HASH=$(echo "${{ secrets.AZURE_SUBSCRIPTION_ID }}" | md5sum | cut -c1-6)
          ACR="${ACR_NAME}${HASH}"
          az acr create \
            --name "$ACR" \
            --resource-group "$RG_NAME" \
            --sku Basic \
            --admin-enabled true \
            2>/dev/null || true
          # Ensure admin is enabled (idempotent)
          az acr update --name "$ACR" --admin-enabled true -o none 2>/dev/null || true
          echo "acr_name=$ACR" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        id: push
        run: |
          ACR="${{ steps.create-acr.outputs.acr_name }}"
          IMAGE="${ACR}.azurecr.io/haymaker-workload:${{ github.sha }}"

          az acr login --name "$ACR"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

          # Also tag as latest
          docker tag "$IMAGE" "${ACR}.azurecr.io/haymaker-workload:latest"
          docker push "${ACR}.azurecr.io/haymaker-workload:latest"

          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

  # -------------------------------------------------------------------
  # Job 2: Deploy infrastructure via Bicep
  # -------------------------------------------------------------------
  deploy:
    needs: build
    runs-on: ubuntu-latest
    outputs:
      app_name: ${{ steps.bicep.outputs.app_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Bicep
        id: bicep
        run: |
          RESULT=$(az deployment group create \
            --resource-group "$RG_NAME" \
            --template-file infra/main.bicep \
            --parameters \
              image="${{ needs.build.outputs.image }}" \
              acrName="${{ needs.build.outputs.acr_name }}" \
              environment="${{ inputs.environment }}" \
              anthropicApiKey="${{ secrets.ANTHROPIC_API_KEY }}" \
              azureOpenAiEndpoint="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
              azureOpenAiDeployment="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
            --query "properties.outputs" \
            -o json)

          APP_NAME=$(echo "$RESULT" | jq -r '.appName.value')
          echo "app_name=$APP_NAME" >> "$GITHUB_OUTPUT"
          echo "Deployed Container App: $APP_NAME"

      - name: Wait for container to be ready
        run: |
          APP="${{ steps.bicep.outputs.app_name }}"
          echo "Waiting for container app $APP to be ready..."
          for i in $(seq 1 20); do
            STATUS=$(az containerapp show \
              --name "$APP" \
              --resource-group "$RG_NAME" \
              --query "properties.provisioningState" -o tsv 2>/dev/null || echo "pending")
            echo "  Attempt $i: $STATUS"
            if [ "$STATUS" = "Succeeded" ]; then
              echo "Container app is ready."
              exit 0
            fi
            sleep 15
          done
          echo "Timed out waiting for container app."
          exit 1

  # -------------------------------------------------------------------
  # Job 3: E2E verification using haymaker CLI inside the container
  #
  # Uses `az containerapp revision copy` to run a one-off revision
  # with haymaker commands (az containerapp exec requires a TTY and
  # does not work in CI).
  # -------------------------------------------------------------------
  verify:
    needs: [build, deploy]
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Haymaker E2E - full lifecycle
        run: |
          ACR="${{ needs.build.outputs.acr_name }}"
          IMAGE="${ACR}.azurecr.io/haymaker-workload:${{ github.sha }}"
          ACR_USER=$(az acr credential show --name "$ACR" --query username -o tsv)
          ACR_PASS=$(az acr credential show --name "$ACR" --query 'passwords[0].value' -o tsv)

          # Delete any previous test job (idempotent)
          az containerapp job delete \
            --name "haymaker-e2e-test" \
            --resource-group "$RG_NAME" \
            --yes 2>/dev/null || true

          # Create a Container Apps Job that runs the E2E test script
          # (baked into the image at /usr/local/bin/haymaker-e2e-test)
          echo "==> Creating E2E test job"
          az containerapp job create \
            --name "haymaker-e2e-test" \
            --resource-group "$RG_NAME" \
            --environment "haymaker-env-${{ inputs.environment }}" \
            --image "$IMAGE" \
            --registry-server "${ACR}.azurecr.io" \
            --registry-username "$ACR_USER" \
            --registry-password "$ACR_PASS" \
            --trigger-type Manual \
            --replica-timeout 28800 \
            --replica-retry-limit 0 \
            --cpu 4 --memory 16Gi \
            --workload-profile-name D4 \
            --parallelism 1 \
            --replica-completion-count 1 \
            --env-vars "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" "CLAUDECODE=" "AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}" "AZURE_OPENAI_DEPLOYMENT=${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" "LLM_PROVIDER=anthropic" \
            --command "haymaker-e2e-test" \
            -o none

          echo "==> Starting E2E job"
          EXECUTION=$(az containerapp job start \
            --name "haymaker-e2e-test" \
            --resource-group "$RG_NAME" \
            --query name -o tsv)
          echo "Execution: $EXECUTION"

          # Poll for completion with periodic OIDC re-authentication.
          # OIDC tokens expire after 5 minutes; re-auth every 4 minutes (24 iterations Ã— 10s).
          # We request a FRESH token from GitHub's OIDC provider each time (the static
          # AZURE_FEDERATED_TOKEN_FILE written by azure/login is not refreshed).
          echo "==> Waiting for E2E job..."
          for i in $(seq 1 480); do
            # Re-authenticate every 24 polls (~4 min) to avoid OIDC token expiry
            if [ $((i % 24)) -eq 1 ]; then
              FRESH_TOKEN=$(curl -sS \
                -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                -H "Accept: application/json; api-version=2.0" \
                "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=api://AzureADTokenExchange" \
                | jq -r '.value' 2>/dev/null) || true
              if [ -n "$FRESH_TOKEN" ] && [ "$FRESH_TOKEN" != "null" ]; then
                az login --service-principal \
                  --username "${{ secrets.AZURE_CLIENT_ID }}" \
                  --tenant "${{ secrets.AZURE_TENANT_ID }}" \
                  --federated-token "$FRESH_TOKEN" \
                  -o none 2>/dev/null || echo "  [warn] re-auth failed, continuing..."
              fi
            fi
            STATUS=$(az containerapp job execution show \
              --name "haymaker-e2e-test" \
              --resource-group "$RG_NAME" \
              --job-execution-name "$EXECUTION" \
              --query "properties.status" -o tsv 2>/dev/null || echo "Unknown")
            echo "  [$i] $STATUS"
            if [ "$STATUS" = "Succeeded" ] || [ "$STATUS" = "Failed" ]; then
              break
            fi
            sleep 10
          done

          # Show logs
          echo "==> E2E logs:"
          az containerapp job logs show \
            --name "haymaker-e2e-test" \
            --resource-group "$RG_NAME" \
            --execution "$EXECUTION" \
            --container "haymaker-e2e-test" 2>&1 || true

          # Cleanup
          az containerapp job delete \
            --name "haymaker-e2e-test" \
            --resource-group "$RG_NAME" \
            --yes 2>/dev/null || true

          if [ "$STATUS" != "Succeeded" ]; then
            echo "E2E FAILED (status: $STATUS)"
            exit 1
          fi
          echo "=== E2E PASSED ==="
